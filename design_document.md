# Project Vision
Build a stream-ready **autonomous world** in **Godot 4 (2D)**â€”think top-down PokÃ©mon-styleâ€”with characters who perceive, plan, and **socially** interact (no combat for now) in a living environment. The simulation is **single-player or no-player**, with the "player" acting primarily as an observer. The player may optionally direct certain actions via console commands. **Conversations between characters will be dynamically generated by a local LLM (via LM Studio)**, informed by relationship status, mood, proximity, and other relevant state data. Conversations are scalable, allowing any number of nearby characters to join, leave, interrupt, or shift topics dynamically. Characters can develop memories, change moods, and adjust relationships based on conversational events. The sim remains deterministic and reacts to external events (later: Twitch chat, Streamlabs) via a simple message bridge. The design is **data-driven** (actions/affordances in JSON), **component-based**, and **planner-pluggable** (Utility AI first, GOAP/BT swappable).

---

## ðŸ“Š **PROJECT STATUS OVERVIEW**

### **Implementation Progress: 75% Complete**
- **âœ… COMPLETED SYSTEMS (5/7)**
  - LLM Integration & Conversation Engine
  - Multi-Party Conversation System
  - Character Status Management (StatusComponent)
  - Action System & Planning (ActionPlanner, ActionExecutor)
  - Character Management (CharacterManager)
  
- **ðŸ”„ IN PROGRESS (1/7)**
  - Memory Compression & Relationship Management
  
- **ðŸš§ PLANNED (1/7)**
  - Character Memory System & Action Randomization

### **Current Sprint Status**
- **Sprint 0-3:** âœ… **100% COMPLETE** - Core conversation, action, and character systems
- **Sprint 4:** ðŸš§ **PLANNING** - Memory system and action randomization
- **Next Focus:** Character Memory System implementation

### **Population & Scale**
- **Characters:** 25+ island village population fully supported
- **Actions:** 20+ comprehensive actions covering all character needs
- **Locations:** 15+ specialized island locations with action support
- **Performance:** Designed for 1000+ memories per character

---

## Character Actions (Non-Conversation) âœ… **IMPLEMENTED**
In addition to conversing, characters can perform a comprehensive range of autonomous actions driven by their needs, personality, and environment. All actions are defined in `data/actions/basic_actions.json` and managed by the `ActionPlanner` system.

### Action Categories & Examples

#### Physical Needs (Energy, Hunger, Thirst, Health) âœ…
- **eat_meal**: Consume food to satisfy hunger (80) and energy (30) - 15 min, kitchen/dining
- **drink_water**: Hydrate to satisfy thirst (60) - 2 min, kitchen/bathroom/outdoors
- **sleep**: Full sleep for energy (100) and health (20) recovery - 8 hours, bedroom
- **take_bath**: Clean oneself for comfort (40) and cleanliness (80) - 30 min, bathroom
- **exercise**: Physical activity for health (30) and achievement (20) - 60 min, gym/outdoors

#### Comfort Needs (Temperature, Cleanliness, Comfort) âœ…
- **take_bath**: Cleanliness and comfort improvement
- **sleep**: Comfort and rest in safe, quiet locations
- **read_book**: Mental comfort and relaxation - 60 min, library/home/bedroom

#### Activity Needs (Boredom, Curiosity, Achievement) âœ…
- **read_book**: Satisfy curiosity (50) and reduce boredom (-30) - 60 min, library/home
- **cook_meal**: Achievement (30) and curiosity (20) - 45 min, kitchen
- **explore_island**: Curiosity (60) and achievement (25) - 120 min, outdoors
- **visit_stone_circle**: Curiosity (50) and comfort (30) - 60 min, stone_circle

#### Economic Needs (Wealth, Material, Security) âœ…
- **work_job**: Achievement (60) and wealth (40) - 4 hours, workplace
- **go_fishing**: Achievement (40) and wealth (30) - 3 hours, fishing_docks
- **build_boat**: Achievement (60) and wealth (40) - 12 hours, shipworks
- **weave_cloth**: Achievement (45) and wealth (35) - 2 hours, workshop
- **tend_bees**: Achievement (35) and curiosity (25) - 1 hour, bee_hollow
- **make_pottery**: Achievement (50) and wealth (30) - 2.5 hours, pottery_workshop
- **carpentry_work**: Achievement (55) and wealth (35) - 3.3 hours, carpentry_workshop
- **blacksmith_work**: Achievement (60) and wealth (40) - 4 hours, blacksmith
- **gather_herbs**: Achievement (30) and curiosity (40) - 1.5 hours, whispering_woods
- **brew_medicine**: Achievement (50) and wealth (25) - 3 hours, herbalist_shop
- **cook_for_guests**: Achievement (40) and wealth (30) - 2 hours, inn_kitchen
- **serve_guests**: Achievement (25) and wealth (20) - 1.5 hours, inn_common_room
- **bake_bread**: Achievement (45) and wealth (30) - 2.5 hours, bakery
- **farm_work**: Achievement (40) and wealth (25) - 3 hours, farm
- **trade_goods**: Wealth (45) and social (25) - 2 hours, trade_post
- **lighthouse_maintenance**: Achievement (45) and wealth (30) - 1.5 hours, lighthouse

#### Social Needs (Social Need, Social Fatigue) âœ…
- **socialize**: Social need (70) and boredom reduction (-20) - 45 min, social areas
- **cook_for_guests**: Social need (20) and achievement (40) - 2 hours, inn_kitchen
- **serve_guests**: Social need (40) and achievement (25) - 1.5 hours, inn_common_room
- **trade_goods**: Social need (25) and wealth (45) - 2 hours, trade_post

### Action System Features

#### Location-Based Actions âœ… **COMPREHENSIVE COVERAGE**
Actions are tagged with location requirements:
- **Indoor**: home, workplace, shop, library, workshop, bedroom, kitchen, bathroom, office
- **Outdoors**: gym, market, trading post, public areas, exercise areas, new areas
- **Specialized**: food_available, water_available, materials, quiet, dark, comfortable
- **Island-Specific**: fishing_docks, shipworks, bee_hollow, whispering_woods, stone_circle, lighthouse
- **Crafting Areas**: blacksmith, carpentry_workshop, pottery_workshop, herbalist_shop
- **Hospitality**: inn_kitchen, inn_common_room, inn_bedrooms
- **Agriculture**: farm, garden, bee_hollow
- **Commerce**: trade_post, market_stalls, bakery
- **Recreation**: village_green, pebble_beach, high_bluff, tide_pools
- **Maritime**: crescent_bay, netshed, boat

#### Need Satisfaction Mapping
Each action specifies:
- **Satisfies**: Which needs the action addresses
- **Costs**: Resources consumed (time, energy, money, materials)
- **Effects**: Quantified impact on need values
- **Duration**: How long the action takes to complete



#### Scoring & Selection
The ActionPlanner calculates action scores based on:
- **Need Urgency**: How badly a need must be satisfied
- **Cost Analysis**: Energy, time, and resource availability
- **Location Bonus**: Whether current location supports the action

- **Base Score**: Inherent action desirability

### Console Integration
Actions can be managed via console commands:
- `:action <npc_id> plan` - Plan next action based on needs
- `:action <npc_id> force <action_id>` - Force specific action
- `:action <npc_id> clear` - Clear current action plan
- `:action <npc_id> actions` - List available actions
- `:action <npc_id> score <action_id>` - Show action score

### Autonomous Behavior
Characters automatically:
- **Analyze Needs**: Assess current need states and priorities
- **Score Actions**: Calculate suitability of all available actions
- **Select Best**: Choose the highest-scoring action
- **Execute**: Perform the selected action
- **Update Needs**: Apply action effects to need values

### Population Coverage âœ… **COMPLETE ISLAND VILLAGE SUPPORT**

The action system now comprehensively covers all 25+ characters from the island village population:

#### **Maritime & Fishing**
- **Elias Thorn (Fisherman)**: `go_fishing` with specialized fishing docks locations
- **Orin & Jessa Pike (Boatwrights)**: `build_boat` with shipworks workshop

#### **Crafting & Artisan Work**
- **Maren Thorn (Weaver)**: `weave_cloth` with home workshop
- **Rowan Sedge (Beekeeper)**: `tend_bees` with bee_hollow outdoors
- **Anya Carden (Potter)**: `make_pottery` with pottery_workshop
- **Varo Dray (Carpenter)**: `carpentry_work` with carpentry_workshop
- **Bram Wynn (Blacksmith)**: `blacksmith_work` with forge

#### **Herbalism & Medicine**
- **Liora & Tamsin Vale (Herbalists)**: `gather_herbs` and `brew_medicine`
- **Whispering Woods**: Specialized herbalism location

#### **Hospitality & Service**
- **Inn Staff**: `cook_for_guests` and `serve_guests` with inn locations
- **Bakery**: `bake_bread` for village food supply

#### **Agriculture & Trade**
- **Farm Workers**: `farm_work` with agricultural locations
- **Merchants**: `trade_goods` at trade post and market

#### **Recreation & Culture**
- **Stone Circle**: `visit_stone_circle` for spiritual activities
- **Exploration**: `explore_island` for adventure and discovery
- **Lighthouse**: `lighthouse_maintenance` for maritime safety

This system creates realistic, need-driven behavior where characters naturally seek to satisfy their most urgent needs while considering their current situation and available resources.

---

## Conversational AI Subsystem
**Overview:** Integrates with LM Studio to generate dynamic, context-aware dialogue between NPCs.
- **Context Schema:** Includes mood, health, relationship summaries, recent topics, goals, and location.
- **Output Schema:** `{utterance, intent, summary_note, relationship_effects, mood_shift}`.
- **Prompt Templates:** Stored in JSON; system message defines persona, constraints, and world rules.
- **Turn Flow:** ConversationController gathers context â†’ LLMClient sends to LM Studio â†’ parses JSON reply â†’ DialogueComponent displays.
- **Sampling Settings:** Semi-deterministic (temp ~0.7, top_p ~0.9) for variation with consistency.
- **Fallback Templates:** Canned lines for when LLM unavailable.
- **Godot Components:** `LLMClient` (autoload) handles API calls; `DialogueComponent` manages active lines & speaker state.
- **Cursor Tasks:** Implement autoload, prompt builder, JSON parser, and fallback templates.

---

## Conversation Engine (Multiâ€‘Party & Dynamic)
**Runtime Objects:**
- `ConversationController`: Oversees all active conversations.
- `ConversationGroup`: Tracks participants, topic stack, memory, and timing.
- `FloorManager`: Manages speaking order and interrupts.
- `TopicManager`: Handles topic relevance, switching, and event injection.
- `ProximityAgent`: Detects nearby NPCs and invites/joins groups.
- `ContextPacker`: Assembles per-turn LLM context.

**Lifecycle:** initiate â†’ join/leave dynamically â†’ interrupt â†’ topic change â†’ disband.
**Join/Leave Logic:** Based on social drive, proximity, and invitation rules.
**Memory Effects:** Dialogue summaries update relationship scores and mood.
**Performance:** Limit tokens, compress memory periodically, parallelize LLM requests.
**Godot Signals:** `conversation_started`, `speaker_changed`, `topic_changed`, `conversation_ended`.
**Director Console:** Commands to force topic changes, merge groups, or insert events.

---

## Concurrency Model â€” Multiple Conversations at Once
- Supports **N simultaneous ConversationGroups**.
- **Scheduler:** Round-robin with per-group cooldowns and jitter to avoid LLM spikes.
- **Caps:** Configurable `max_active_groups` and `max_participants_per_group`.
- **Isolation:** Memories and topics scoped per group.
- **Backpressure:** Fallback to templates if LLM busy.

---

## World Events â†’ Conversation Hooks
- **Event Sources:** Weather, economy, civic events, social milestones.
- **Integration:** Event bus publishes â†’ TopicManager maps to topic hints â†’ ContextPacker includes hint.
- **Behavior:** Events decay in priority; segues allowed only once per interval.
- **Memory:** Tag participants as "heard_about_X" for future recall.
- **Config:** `dialogue/event_topics.json` defines mapping.
- **DevConsole Commands:** `:event weather rain`, `:event festival harvest`, etc.

---

## Participation Invariant â€” One Conversation Per NPC
- **Index:** `participant_index[npc_id] = group_id`.
- **Guard:** `try_add_participant` denies join if already in group.
- **Transfer:** Safe atomic moves between groups.
- **Cleanup:** Remove index entry on leave.
- **Rejoin Cooldown:** Prevents churn.
- **Debug UI:** Shows index state and violations.

---

## Social Fatigue & Social Need (Extrovert/Introvert Dynamics)
- **Variables:** `social_need`, `social_fatigue`, `extroversion`.
- **Drive Function:** `(SN - k_fatigue * SF) + k_trait * E` influences join/leave/talk.
- **Accrual:** Fatigue rises with speaking/listening/group size; need drops with exposure.
- **Recovery:** Fatigue drops in solitude/rest; need rises when under-social.
- **Extroversion Shaping:** Alters setpoints and rate changes.
- **Behavioral Effects:** Impacts join probability, leave triggers, topic length.
- **Godot Integration:** NeedsComponent updated each tick; FloorManager & ConversationController adjust behavior accordingly.
- **Debug UI:** Displays fatigue/need bars.

---

## Character Status Management System
**Overview:** Comprehensive system managing all NPC needs, states, and drives to determine non-conversation actions and behaviors.

### Core Need Components

#### Physical Needs
- **Energy/Stamina** (`energy`): 0.0 = exhausted, 1.0 = fully energized
  - Decreases with movement, work, and time
  - Recovers with rest, sleep, and food
  - Drives: rest actions, movement speed, work capacity
  
- **Hunger** (`hunger`): 0.0 = satiated, 1.0 = starving
  - Increases over time and with physical activity
  - Decreases with eating and drinking
  - Drives: food-seeking, cooking, dining behaviors
  
- **Thirst** (`thirst`): 0.0 = hydrated, 1.0 = dehydrated
  - Increases faster than hunger
  - Decreases with drinking
  - Drives: water-seeking, beverage consumption
  
- **Health** (`health`): 0.0 = critical, 1.0 = perfect
  - Affected by illness, injury, poor conditions
  - Recovers with rest, medicine, good nutrition
  - Drives: healing actions, medical seeking, self-care

#### Comfort & Environment Needs
- **Temperature Comfort** (`temp_comfort`): -1.0 = too cold, 0.0 = comfortable, 1.0 = too hot
  - Affected by weather, clothing, location
  - Drives: clothing changes, seeking shelter, temperature regulation
  
- **Cleanliness** (`cleanliness`): 0.0 = filthy, 1.0 = pristine
  - Decreases with work, weather, time
  - Increases with washing, grooming
  - Drives: hygiene actions, clothing maintenance
  
- **Comfort** (`comfort`): 0.0 = uncomfortable, 1.0 = very comfortable
  - Affected by seating, clothing, environment
  - Drives: posture changes, furniture seeking, relaxation

#### Activity & Engagement Needs
- **Boredom** (`boredom`): 0.0 = engaged, 1.0 = extremely bored
  - Increases with inactivity and repetitive tasks
  - Decreases with varied activities and entertainment
  - Drives: leisure activities, exploration, personal growth
  
- **Curiosity** (`curiosity`): 0.0 = satisfied, 1.0 = very curious
  - Increases with new stimuli and unanswered questions
  - Decreases with exploration and learning
  - Drives: investigation, reading, asking questions
  
- **Achievement Need** (`achievement_need`): 0.0 = satisfied, 1.0 = seeking accomplishment
  - Increases with time since last success
  - Decreases with completing tasks and goals
  - Drives: work, practice, goal pursuit

#### Economic & Material Needs
- **Wealth Satisfaction** (`wealth_satisfaction`): 0.0 = poor, 1.0 = wealthy
  - Affected by current money, possessions, economic status
  - Drives: work, trading, saving, spending
  
- **Material Need** (`material_need`): 0.0 = satisfied, 1.0 = urgent need
  - Specific to required items (tools, clothing, etc.)
  - Drives: shopping, crafting, borrowing, theft
  
- **Security Need** (`security_need`): 0.0 = secure, 1.0 = threatened
  - Affected by danger, crime, instability
  - Drives: seeking safety, defensive actions, community building

### Need Interaction & Prioritization

#### Need Hierarchy
1. **Critical Needs** (health < 0.2, energy < 0.1, hunger/thirst > 0.9)
2. **High Priority** (comfort < 0.3, cleanliness < 0.2, security > 0.7)
3. **Medium Priority** (boredom > 0.6, curiosity > 0.7, achievement > 0.6)
4. **Low Priority** (social, entertainment, luxury)

#### Need Conflicts & Compromises
- **Energy vs. Achievement**: High achievement need may override low energy
- **Social vs. Rest**: Social needs may conflict with rest requirements
- **Curiosity vs. Safety**: Exploration may conflict with security needs
- **Work vs. Leisure**: Economic needs vs. entertainment desires

#### Need Decay & Recovery Rates
- **Fast Decay** (seconds): energy during activity, thirst, temp_comfort
- **Medium Decay** (minutes): hunger, cleanliness, boredom
- **Slow Decay** (hours): health, wealth_satisfaction, achievement_need
- **Variable Recovery**: Depends on action effectiveness and conditions

### Action Drive Calculation

#### Primary Action Selection
```gdscript
func calculate_action_drive(need_type: String) -> float:
    var base_need = needs[need_type]
    var urgency = 1.0 - base_need  # Higher need = higher urgency
    var personality_modifier = get_personality_modifier(need_type)
    var environmental_modifier = get_environmental_modifier(need_type)
    
    return urgency * personality_modifier * environmental_modifier
```

#### Action Priority Scoring
```gdscript
func score_action(action: Dictionary) -> float:
    var total_score = 0.0
    for need_type in action.satisfies_needs:
        var satisfaction = action.satisfies_needs[need_type]
        var drive = calculate_action_drive(need_type)
        total_score += satisfaction * drive
    
    # Apply action costs (energy, time, resources)
    total_score -= action.cost_multiplier
    
    return total_score
```

### Personality Traits & Modifiers

#### Big Five Personality Model
- **Openness**: Affects curiosity, creativity, and exploration drives
- **Conscientiousness**: Affects achievement, cleanliness, and work ethic
- **Extraversion**: Affects social needs and activity preferences
- **Agreeableness**: Affects cooperation, helping, and conflict avoidance
- **Neuroticism**: Affects stress response and need sensitivity

#### Cultural & Background Modifiers
- **Profession**: Affects work ethic, work priorities, and economic drives
- **Social Class**: Affects luxury needs, status seeking, and comfort standards
- **Age**: Affects energy levels, curiosity, and risk tolerance
- **Life Experience**: Affects fear responses, curiosity, and achievement goals

### Environmental & Contextual Factors

#### Weather & Season Effects
- **Rain**: Increases cleanliness decay, decreases comfort, affects movement
- **Heat**: Increases thirst, decreases energy, affects clothing choices
- **Cold**: Increases hunger, affects clothing and shelter seeking
- **Season**: Affects available activities, clothing needs, and mood

#### Time of Day Effects
- **Morning**: High energy, low hunger, high achievement drive
- **Afternoon**: Moderate energy, increasing hunger, social drive
- **Evening**: Decreasing energy, entertainment needs, social relaxation
- **Night**: Low energy, rest needs, security concerns

#### Location & Context Effects
- **Home**: High comfort, low security concerns, high rest potential
- **Work**: High achievement drive, moderate comfort, social interaction
- **Public**: High curiosity, social observation, security awareness
- **Nature**: High exploration, low comfort, environmental interaction

### Implementation Architecture

#### StatusComponent
- **Core Need Management**: Tracks all need values and decay rates
- **Need Interaction**: Handles conflicts and compromises
- **Action Scoring**: Calculates drive for different actions
- **Personality Integration**: Applies trait modifiers to needs

#### ActionPlanner
- **Need Analysis**: Identifies most urgent needs
- **Action Selection**: Chooses best action for current state
- **Conflict Resolution**: Handles competing needs
- **Planning Horizon**: Short-term (immediate) vs. long-term (goals)

#### EnvironmentalSensor
- **Context Detection**: Identifies current location and conditions
- **Weather Monitoring**: Tracks environmental effects
- **Time Awareness**: Manages circadian rhythms
- **Resource Detection**: Identifies available actions and items

#### Debug & Monitoring
- **Need Visualization**: Real-time need bars and trends
- **Action Logging**: Records decisions and their reasoning
- **Performance Metrics**: Tracks need satisfaction efficiency
- **Console Commands**: Manual need manipulation and testing

### Action Execution System

#### Core Features
- **Action Lifecycle Management**: Complete control over action start, pause, resume, and completion
- **Progress Tracking**: Real-time progress updates with configurable intervals
- **Interruption Handling**: Priority-based interruption system with partial effect application
- **Completion Effects**: Comprehensive effect application including needs and inventory

#### Action States
- **IDLE**: No action currently executing
- **PREPARING**: Action is being set up and costs are being applied
- **EXECUTING**: Action is actively running and progress is being tracked
- **PAUSED**: Action is temporarily suspended but can be resumed
- **INTERRUPTED**: Action was stopped before completion with partial effects
- **COMPLETED**: Action finished successfully with full effects applied
- **FAILED**: Action failed with failure penalties applied

#### Progress System
- **Time-Based Progress**: Progress calculated based on action duration
- **Update Intervals**: Configurable progress update frequency (default: 100ms)
- **Smooth Transitions**: Gradual progress increments for realistic timing
- **Completion Detection**: Automatic completion when progress reaches 100%

#### Interruption System
- **Priority-Based**: Higher priority actions can interrupt lower priority ones
- **Configurable**: Actions can be set as non-interruptible or with custom priority
- **Partial Effects**: Interrupted actions apply effects proportional to progress made
- **Clean State**: Proper cleanup and state management after interruption

#### Effect Application
- **Need Satisfaction**: Applies need changes based on action completion

- **Inventory Changes**: Modifies character inventory (consuming/gaining items)
- **Special Effects**: Applies unique effects defined in action data
- **Failure Penalties**: Applies negative effects when actions fail

#### Console Integration
- **execute start <action_id> [npc_id]**: Start executing an action
- **execute pause**: Pause current action execution
- **execute resume**: Resume paused action execution
- **execute interrupt <reason> [priority]**: Interrupt current action
- **execute complete**: Manually complete current action
- **execute fail <error>**: Manually fail current action
- **execute status**: Get current action execution status
- **execute progress**: Get current action progress

---

## Character Management System âœ… **IMPLEMENTED**

**Overview:** Centralized system for managing all NPCs in the simulation, including creation, loading, saving, and lifecycle management. The CharacterManager integrates with StatusComponent, ActionPlanner, and existing conversation systems to provide a unified character experience.

### Core Architecture

#### CharacterManager (Autoload)
- **Central Registry**: Maintains active characters in memory with unique IDs
- **Template System**: Loads base character template and individual character templates
- **Component Integration**: Manages StatusComponent and ActionPlanner instances
- **Population Management**: Tracks character count and enforces population limits
- **Data Persistence**: Handles saving/loading character data to/from JSON files

#### Character Data Structure
Each character includes comprehensive information:
- **Identity**: character_id, name, description, occupation, specialization
- **Personality**: Big Five traits and custom personality modifiers
- **Needs**: Current values, decay rates, and recovery rates for all 5 categories

- **Inventory**: Money, items, clothing, tools, and possessions
- **Schedule**: Sleep patterns, work times, meal preferences
- **Relationships**: Affection, trust, and interaction history with other characters
- **Memories**: Significant events with timestamps and emotional impact
- **Goals**: Current objectives with priority, progress, and requirements
- **Location**: Current position, home, and workplace assignments
- **Drama Hooks**: Character-specific story elements and conflicts

### Character Lifecycle Management

#### Initialization Process
1. **Template Loading**: Loads base template and character-specific templates
2. **Population Setup**: Creates characters from templates or loads saved data
3. **Component Creation**: Initializes StatusComponent and ActionPlanner for each character
4. **Data Validation**: Ensures character data meets required structure and constraints
5. **Population Count**: Updates and emits population change signals

#### Character Creation
- **Template-Based**: Merges base template with character-specific data
- **Deep Merge Logic**: Intelligently combines needs and other complex data
- **Component Setup**: Creates and configures all necessary character components
- **Initial Save**: Persists character data to disk immediately after creation
- **Signal Emission**: Notifies system of new character addition

#### Data Persistence
- **Save Directory**: User-specific directory for character data persistence
- **JSON Format**: Human-readable character data storage
- **Auto-Save**: Automatic saving on character updates and system exit
- **Data Integrity**: Validation and error handling for corrupted data
- **Backup Support**: Safe overwriting with error recovery

### Character Query System

#### Location-Based Queries
- **By Location**: Find all characters at specific locations
- **By Location Type**: Query characters by location categories (indoor, outdoor, specialized)
- **Proximity**: Identify characters near specific areas or other characters



#### Need-Based Queries
- **By Need Category**: Find characters with urgent needs in specific areas
- **By Need Threshold**: Query characters below need satisfaction thresholds
- **Urgent Needs**: Identify characters requiring immediate attention

#### Population Analytics
- **Summary Statistics**: Location breakdowns, urgent need counts
- **Export Functionality**: Detailed population data for analysis and debugging
- **Trend Analysis**: Track population changes over time

### Integration with Existing Systems

#### StatusComponent Integration
- **Need Management**: CharacterManager provides character data to StatusComponent
- **Personality Effects**: Personality traits influence need calculations and behaviors
- **Environmental Awareness**: Location and context affect need satisfaction

#### ActionPlanner Integration
- **Action Selection**: Character needs inform action planning
- **Location Constraints**: Current location affects available actions
- **Resource Management**: Inventory and economic status influence action costs

#### Conversation System Integration
- **Relationship Data**: Character relationships inform conversation dynamics
- **Memory Integration**: Character memories provide conversation context
- **Mood Effects**: Current need states influence conversation behavior

### Console Integration

#### Population Commands
- `:population count` - Display current character count
- `:population summary` - Show population overview with location breakdowns
- `:population export` - Export detailed population data

#### Character Management Commands
- `:character_manager list` - List all active characters
- `:character_manager get <id>` - Display detailed character information
- `:character_manager save <id>` - Save specific character to disk
- `:character_manager save_all` - Save all characters to disk
- `:character_manager create <id>` - Create new character from template
- `:character_manager delete <id>` - Remove character from simulation
- `:character_manager by_location <loc>` - Find characters at specific location

- `:character_manager by_need <cat> <need> [threshold]` - Find characters with urgent needs

### Island Village Population Support

The CharacterManager now supports the complete island village population:

#### **Maritime & Fishing Characters**
- **Elias Thorn**: Fisherman with boat upgrade goals and family dynamics
- **Orin Pike**: Boatwright with craftsmanship and community relationships
- **Jessa Pike**: Boatwright apprentice with learning goals and social connections

#### **Crafting & Artisan Characters**
- **Maren Thorn**: Weaver with home workshop and family responsibilities
- **Rowan Sedge**: Beekeeper with outdoor work and natural knowledge
- **Anya Carden**: Potter with artistic abilities and creative goals
- **Varo Dray**: Carpenter with construction abilities and community projects
- **Bram Wynn**: Blacksmith with forge work and material crafting

#### **Herbalism & Medicine Characters**
- **Liora Vale**: Master herbalist with extensive knowledge and teaching role
- **Tamsin Vale**: Herbalist apprentice with learning goals and family legacy

#### **Hospitality & Service Characters**
- **Inn Staff**: Cooks, servers, and hosts with guest interaction abilities
- **Bakery Workers**: Bakers and sales staff with food production abilities

#### **Agriculture & Trade Characters**
- **Farm Workers**: Agricultural laborers with seasonal work patterns
- **Merchants**: Traders with economic knowledge and market understanding

#### **Recreation & Cultural Characters**
- **Explorers**: Adventurers with curiosity and discovery drives
- **Cultural Figures**: Community leaders with social and organizational abilities

### Performance & Scalability

#### Memory Management
- **Active Characters**: Only essential data kept in memory
- **Lazy Loading**: Character data loaded on demand
- **Component Pooling**: Reuse component instances when possible
- **Garbage Collection**: Proper cleanup of unused character data

#### Population Limits
- **Configurable Caps**: Adjustable maximum population size
- **Performance Monitoring**: Track memory and processing usage
- **Scalability Planning**: Design for future population growth

#### Data Optimization
- **Efficient Storage**: Compressed data formats for large populations
- **Update Batching**: Group character updates for better performance
- **Background Processing**: Non-blocking character operations

---

## ðŸš§ **TO-DO ITEMS**

### Character Memory System & Relationship Impact
**Priority**: **HIGHEST** | **Status**: Planning Phase | **Estimated Effort**: 3-4 weeks | **Next Sprint**: Sprint 4

#### Overview
Implement a comprehensive memory system that allows characters to form, retain, and recall memories from conversations and action results. Memories will have varying strength, decay over time, impact character mood, and influence relationships. The system will support both temporary and permanent memories, creating a foundation for long-term character development and emergent storytelling.

#### Current State
- Characters lack persistent memory of past interactions
- No relationship development based on shared experiences
- Missing emotional impact from significant events
- No memory-driven behavior modification

#### Required Features

##### **Memory Creation & Sources**
- **Conversation Memories**: 
  - Topics discussed, emotional tone, relationship changes
  - Shared experiences, agreements, conflicts, revelations
  - Group dynamics and social positioning
  
- **Action Result Memories**:
  - Success/failure experiences, skill demonstrations
  - Collaborative work, shared achievements, accidents
  - Economic transactions, resource sharing, assistance given/received
  
- **Environmental Memories**:
  - Weather events, seasonal changes, natural phenomena
  - Location-specific experiences, discoveries, dangers
  - Community events, celebrations, crises

##### **Memory Properties & Structure**
- **Memory Strength** (0.0 - 1.0):
  - Emotional intensity of the experience
  - Personal relevance and impact
  - Frequency of recall and reinforcement
  
- **Memory Type**:
  - **Episodic**: Specific events with time, place, participants
  - **Semantic**: General knowledge, facts, learned information
  - **Emotional**: Feelings, moods, emotional states
  - **Relationship**: Social bonds, trust, conflicts, alliances
  
- **Memory Tags**:
  - Participants involved, locations, emotions, themes
  - Economic impact, social significance, personal importance
  - Cultural relevance, community impact, family connections

##### **Memory Decay & Persistence**
- **Time Decay**: Memories naturally fade over time
  - **Fast Decay** (hours): Minor interactions, routine events
  - **Medium Decay** (days): Regular conversations, work results
  - **Slow Decay** (weeks): Significant events, relationship changes
  - **Very Slow Decay** (months): Major life events, deep relationships
  
- **Permanent Memories**:
  - **Trauma**: Deeply negative experiences that persist
  - **Milestones**: Major life achievements and turning points
  - **Core Relationships**: Family bonds, lifelong friendships
  - **Cultural Events**: Community traditions, historical moments
  
- **Memory Reinforcement**:
  - **Recall**: Thinking about or discussing memories strengthens them
  - **Repetition**: Similar experiences reinforce related memories
  - **Emotional Association**: Strong emotions create stronger memories

##### **Mood & Emotional Impact**
- **Mood Modification**: Memories influence current emotional state
  - **Positive Memories**: Boost happiness, confidence, social desire
  - **Negative Memories**: Increase stress, fear, social withdrawal
  - **Neutral Memories**: Provide context without emotional impact
  
- **Emotional Triggers**: Specific memories can be triggered by:
  - Similar situations or locations
  - Related people or topics
  - Seasonal or environmental cues
  - Current needs or stressors

##### **Relationship Impact & Development**
- **Trust Building**: Positive shared experiences increase trust
- **Conflict Resolution**: Memories of apologies and reconciliation
- **Social Bonds**: Repeated positive interactions strengthen relationships
- **Reputation System**: How others remember and talk about characters
- **Family Dynamics**: Inherited memories and family traditions
- **Community Standing**: Public perception based on remembered actions

#### Technical Implementation

##### **Memory Data Structure**
```json
{
  "memory_id": "unique_identifier",
  "character_id": "owner_character",
  "memory_type": "episodic|semantic|emotional|relationship",
  "title": "Brief description",
  "description": "Detailed memory content",
  "participants": ["character_id1", "character_id2"],
  "location": "location_id",
  "timestamp": "creation_time",
  "last_recalled": "last_recall_time",
  "strength": 0.85,
  "decay_rate": 0.001,
  "is_permanent": false,
  "tags": ["fishing", "success", "friendship"],
  "emotional_impact": {
    "happiness": 0.3,
    "trust": 0.2,
    "fear": -0.1,
    "excitement": 0.1
  },
  "relationship_changes": {
    "character_id": "trust_change",
    "character_id2": "friendship_change"
  },
  "economic_impact": 15,
  "social_significance": 0.4
}
```

##### **Memory Management System**
- **MemoryStorage**: Central component for memory CRUD operations
- **MemoryRetrieval**: Search and recall memories based on context
- **MemoryDecay**: Automatic strength reduction over time
- **MemoryIntegration**: Connect with StatusComponent and relationships
- **MemoryPersistence**: Save/load memories to/from character data

##### **Integration Points**
- **ConversationController**: Create memories from dialogue outcomes
- **ActionExecutor**: Generate memories from action results
- **StatusComponent**: Apply memory-based mood modifications
- **CharacterManager**: Store and retrieve character memories
- **RelationshipSystem**: Update social bonds based on memories

#### Console Commands
- `:memory <character_id> list [filter]` - List character memories
- `:memory <character_id> create <type> <title> <description>` - Create test memory
- `:memory <character_id> recall <memory_id>` - Simulate memory recall
- `:memory <character_id> decay <memory_id> <amount>` - Modify memory strength
- `:memory <character_id> permanent <memory_id> <true|false>` - Set permanence
- `:memory <character_id> impact <memory_id>` - Show emotional/relationship impact

#### Success Metrics
- **Memory Persistence**: 90% of significant events should create lasting memories
- **Emotional Impact**: Memories should meaningfully affect character mood and behavior
- **Relationship Development**: Long-term relationships should show memory-driven growth
- **Performance**: Memory system should handle 1000+ memories per character without lag
- **Emergent Storytelling**: Memories should create unexpected narrative connections

---

### Job Action Randomization & Varied Success
**Priority**: **HIGH** | **Status**: Planning Phase | **Estimated Effort**: 2-3 weeks | **Next Sprint**: Sprint 5

#### Overview
Implement random results and varied success outcomes for job and work-related actions to create more realistic and engaging gameplay. Actions like `go_fishing`, `build_boat`, `weave_cloth`, etc. should have different outcomes based on character traits, luck, and environmental factors.

#### Current State
- Actions currently have fixed outcomes and success rates
- No variation in results based on character circumstances
- Missing opportunity for emergent storytelling through action outcomes

#### Required Features

##### **Random Result Generation**
- **Success Variation**: Different levels of success (excellent, good, average, poor, failure)
- **Character Influence**: Character traits and experience affect success probability and quality
- **Luck Factor**: Random chance for exceptional or disastrous results
- **Environmental Factors**: Weather, season, and location affecting outcomes

##### **Action-Specific Results**
- **Fishing Actions** (`go_fishing`):
  - Catch variety (common fish, rare fish, nothing, trash)
  - Quantity variations (0-5 fish based on character traits and luck)
  - Special events (caught in net, line break, boat damage)
  
- **Crafting Actions** (`build_boat`, `weave_cloth`, `make_pottery`):
  - Quality levels (masterpiece, high quality, standard, flawed, broken)
  - Material efficiency (optimal use, waste, complete failure)
  - Time variations (faster than expected, normal, delays, setbacks)
  
- **Work Actions** (`farm_work`, `blacksmith_work`):
  - Productivity variations (high output, normal, low, failure)
  - Resource consumption (efficient, normal, wasteful)
  - Equipment wear and tear

##### **Outcome Integration**
- **Need Satisfaction**: Varied results affect need satisfaction differently
- **Economic Impact**: Quality affects sale prices and reputation
- **Memory Creation**: Significant outcomes create lasting memories
- **Relationship Effects**: Success/failure can affect social standing

#### Technical Implementation

##### **Action Result Schema**
```json
{
  "action_id": "go_fishing",
  "base_success_rate": 0.7,
  "character_modifier": 0.1,
  "luck_range": [-0.2, 0.2],
  "results": {
    "excellent": {"probability": 0.1, "catch_count": [3, 5], "quality": "rare"},
    "good": {"probability": 0.3, "catch_count": [2, 3], "quality": "common"},
    "average": {"probability": 0.4, "catch_count": [1, 2], "quality": "common"},
    "poor": {"probability": 0.15, "catch_count": [0, 1], "quality": "common"},
    "failure": {"probability": 0.05, "catch_count": [0, 0], "quality": "none"}
  },
  "environmental_modifiers": {
    "weather": {"rain": 0.1, "storm": -0.3, "clear": 0.0},
    "season": {"spring": 0.2, "summer": 0.0, "autumn": 0.1, "winter": -0.2},
    "time": {"dawn": 0.1, "day": 0.0, "dusk": 0.0, "night": -0.1}
  }
}
```

##### **Result Calculation System**
- **Base Success**: Action's inherent success probability
- **Character Bonus**: Character trait and experience contribution
- **Luck Roll**: Random factor within defined range
- **Environmental Modifiers**: Weather, season, time of day effects
- **Final Result**: Determines outcome quality and rewards

##### **Integration Points**
- **ActionExecutor**: Apply random results during action completion
- **StatusComponent**: Varied need satisfaction based on results
- **CharacterManager**: Update inventory and memories
- **Console Commands**: Debug and test random result generation

#### Console Commands
- `:action <npc_id> test_random <action_id>` - Test random result generation
- `:action <npc_id> force_result <action_id> <result_type>` - Force specific result
- `:action <npc_id> result_stats <action_id>` - Show result probability distribution

#### Success Metrics
- **Variety**: 80%+ of actions should have at least 3 different outcome levels
- **Character Impact**: Character traits should provide meaningful success rate variations
- **Balance**: No single outcome should occur more than 40% of the time
- **Engagement**: Results should create memorable moments and story hooks

---

## Milestones
- **M2.5 â€” LLM Wiring:** âœ… **COMPLETED** - LM Studio integration, JSON replies, social panel effects.
- **M2.7 â€” Multi-Party Engine:** âœ… **COMPLETED** - Controller, TopicManager, dynamic join/leave.
- **M3.0 â€” Summaries & Budgets:** âœ… **COMPLETED** - Rolling conversation summaries; token caps.
- **M3.5 â€” Memory Compression:** ðŸ”„ **IN PROGRESS** - Consolidate long-term relationship memories.
- **M4.0 â€” Character Management:** âœ… **COMPLETED** - Centralized character system with full lifecycle support.
- **M4.5 â€” Action System:** âœ… **COMPLETED** - Comprehensive action coverage for island village population.
- **M5.0 â€” Memory System:** ðŸš§ **PLANNED** - Character memory system with relationship impact.
- **M5.5 â€” Action Randomization:** ðŸš§ **PLANNED** - Varied success outcomes and random results.

